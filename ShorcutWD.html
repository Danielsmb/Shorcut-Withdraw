import customtkinter as ctk
from tkinter import messagebox
from tkinter import ttk
import re

# Mengatur tampilan tema
ctk.set_appearance_mode("System")  # Bisa diganti "Light" atau "Dark"
ctk.set_default_color_theme("blue")  # Tema warna

class WithdrawApp:
    def __init__(self, root):
        self.root = root
        self.root.title("Web Shortcut Withdraw - Python Version")
        self.root.geometry("900x700")
        
        # Layout Utama
        self.main_frame = ctk.CTkFrame(root)
        self.main_frame.pack(fill="both", expand=True, padx=20, pady=20)

        # Judul
        self.label_title = ctk.CTkLabel(
            self.main_frame, 
            text="Withdraw Besar", 
            font=ctk.CTkFont(size=24, weight="bold")
        )
        self.label_title.pack(pady=(0, 20))

        # Bagian Input Form
        self.input_frame = ctk.CTkFrame(self.main_frame)
        self.input_frame.pack(fill="x", pady=10)

        self.create_input_field("Nominal Total", "nominal_entry")
        self.create_input_field("Nomor Rekening", "nomor_rekening_entry")
        self.create_input_field("ID", "id_entry")
        self.create_input_field("Nama Rekening", "nama_rekening_entry")

        # Tombol Proses
        self.btn_process = ctk.CTkButton(
            self.main_frame, 
            text="Proses", 
            command=self.process_data,
            height=40,
            font=ctk.CTkFont(size=16, weight="bold")
        )
        self.btn_process.pack(pady=20, fill="x")

        # Bagian Output (Cross Check & Tabel)
        self.output_frame = ctk.CTkFrame(self.main_frame)
        self.output_frame.pack(fill="both", expand=True, pady=10)
        
        # Label Total (Cross Check)
        self.lbl_total_display = ctk.CTkLabel(
            self.output_frame,
            text="",
            font=ctk.CTkFont(size=18, weight="bold"),
            text_color="#2ecc71"
        )
        self.lbl_total_display.pack(pady=10)

        # Setup Tabel (Treeview dengan styling CustomTkinter)
        self.setup_table()

        # Tombol Salin
        self.btn_copy = ctk.CTkButton(
            self.output_frame,
            text="Salin Tabel",
            fg_color="#2ecc71",
            hover_color="#27ae60",
            command=self.copy_table,
            state="disabled" # Disabled awal
        )
        self.btn_copy.pack(pady=10)

    def create_input_field(self, label_text, attr_name):
        """Helper untuk membuat input field"""
        frame = ctk.CTkFrame(self.input_frame, fg_color="transparent")
        frame.pack(fill="x", pady=5)
        
        label = ctk.CTkLabel(frame, text=label_text, anchor="w")
        label.pack(fill="x", padx=5)
        
        entry = ctk.CTkEntry(frame, placeholder_text=f"Masukkan {label_text.lower()}")
        entry.pack(fill="x", padx=5, pady=(0, 10))
        
        # Simpan referensi entry ke atribut class agar bisa diakses nanti
        setattr(self, attr_name, entry)

    def setup_table(self):
        """Mengatur tampilan tabel data"""
        # Scrollbar
        scrollbar = ttk.Scrollbar(self.output_frame)
        scrollbar.pack(side="right", fill="y")

        # Kolom Tabel
        columns = ("nominal", "nomor_rekening", "id", "nama_rekening")
        
        self.tree = ttk.Treeview(
            self.output_frame, 
            columns=columns, 
            show="headings", 
            yscrollcommand=scrollbar.set
        )
        
        # Mengatur Header Kolom
        self.tree.heading("nominal", text="Nominal")
        self.tree.heading("nomor_rekening", text="Nomor Rekening")
        self.tree.heading("id", text="ID")
        self.tree.heading("nama_rekening", text="Nama Rekening")

        # Mengatur Lebar Kolom
        self.tree.column("nominal", width=150, anchor="e")
        self.tree.column("nomor_rekening", width=200, anchor="center")
        self.tree.column("id", width=100, anchor="center")
        self.tree.column("nama_rekening", width=250, anchor="w")

        # Styling Tabel agar sinkron dengan tema
        style = ttk.Style()
        style.theme_use("clam") # Menggunakan theme dasar yang mudah dimodifikasi
        
        bg_color = self.output_frame.cget("fg_color")
        fg_color = "black" if ctk.get_appearance_mode() == "Light" else "white"
        
        style.configure("Treeview", 
            background="#f0f0f0", 
            foreground="black", 
            fieldbackground="#f0f0f0", 
            rowheight=25,
            font=("Helvetica", 11)
        )
        style.configure("Treeview.Heading", font=("Helvetica", 12, "bold"))
        
        self.tree.pack(fill="both", expand=True)

    def format_rupiah(self, amount):
        """Format angka menjadi koma pemisah ribuan (contoh: 40.000.000)"""
        return "{:,}".format(amount)

    def process_data(self):
        # 1. Ambil dan bersihkan input
        nominal_str = re.sub(r'\D', '', self.nominal_entry.get())
        
        try:
            total_amount = int(nominal_str)
        except ValueError:
            messagebox.showerror("Error", "Masukkan nominal yang valid (angka).")
            return

        nomor_rekening = self.nomor_rekening_entry.get()
        id_val = self.id_entry.get()
        nama_rekening = self.nama_rekening_entry.get()

        # 2. Validasi
        if total_amount <= 0:
            messagebox.showerror("Error", "Nominal harus lebih besar dari 0.")
            return
        if not nomor_rekening or not id_val or not nama_rekening:
            messagebox.showerror("Error", "Semua kolom harus diisi.")
            return

        # 3. Proses Pemecahan (Logic Sama seperti JS)
        chunk_size = 40000000  # 40 Juta
        full_chunks = total_amount // chunk_size
        remainder = total_amount % chunk_size
        
        data_rows = []

        for _ in range(full_chunks):
            data_rows.append(chunk_size)
            
        if remainder > 0:
            data_rows.append(remainder)

        # 4. Update UI
        # Tampilkan Total Cross Check
        formatted_total = self.format_rupiah(total_amount)
        self.lbl_total_display.configure(text=f"Total Cross-Check: {formatted_total}")

        # Bersihkan tabel lama
        for item in self.tree.get_children():
            self.tree.delete(item)

        # Isi tabel baru
        for nominal in data_rows:
            formatted_nominal = self.format_rupiah(nominal)
            # Kita simpan nilai asli di 'values' tuple tersembunyi atau map manual jika perlu,
            # tapi untuk Treeview sederhana, kita masukkan formatted text.
            # Agar copy berhasil rapi, kita perlu data mentah, jadi simpan dalam list self.raw_data
            self.tree.insert("", "end", values=(formatted_nominal, nomor_rekening, id_val, nama_rekening))
        
        # Simpan data mentah untuk fungsi copy nanti (karena treeview hanya menampilkan string)
        self.raw_data = data_rows

        # Aktifkan tombol copy
        self.btn_copy.configure(state="normal")

    def copy_table(self):
        """Menyalin data tabel ke clipboard berformat Tab Separated"""
        if not hasattr(self, 'raw_data'):
            return

        nomor_rekening = self.nomor_rekening_entry.get()
        id_val = self.id_entry.get()
        nama_rekening = self.nama_rekening_entry.get()
        
        rows_text = []
        
        for amount in self.raw_data:
            # Format: Nominal(tab)No Rek(tab)ID(tab)Nama
            row_str = f"{amount}\t{nomor_rekening}\t{id_val}\t{nama_rekening}"
            rows_text.append(row_str)

        final_text = "\n".join(rows_text)

        # Salin ke clipboard
        self.root.clipboard_clear()
        self.root.clipboard_append(final_text)
        
        messagebox.showinfo("Berhasil", "Tabel berhasil disalin ke clipboard!")

if __name__ == "__main__":
    root = ctk.CTk()
    app = WithdrawApp(root)
    root.mainloop()
